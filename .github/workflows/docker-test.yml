name: Docker Integration Test

on:
  pull_request:
    branches: [ main ]
    paths:
      - 'backend/Dockerfile'
      - 'frontend/Dockerfile'
      - 'docker-compose.yml'
      - '.github/workflows/docker-test.yml'
  workflow_dispatch:

jobs:
  docker-compose-test:
    name: Test Docker Compose Stack
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Create .env file
        run: |
          cat > .env << EOF
          YOUTUBE_API_KEY=${{ secrets.YOUTUBE_API_KEY || 'test_key' }}
          CLAUDE_API_KEY=${{ secrets.CLAUDE_API_KEY || '' }}
          EOF

      - name: Build and start Docker Compose
        run: |
          docker compose up -d --build

      - name: Wait for services to be healthy
        run: |
          echo "Waiting for services to be healthy..."
          timeout 120 bash -c 'until docker compose ps | grep -q "healthy"; do sleep 2; done'

      - name: Check service health
        run: |
          docker compose ps
          echo "---"
          echo "Checking backend health..."
          curl -f http://localhost:8000/health || exit 1
          echo "---"
          echo "Checking frontend..."
          curl -f http://localhost:3000 || exit 1

      - name: Run database migrations
        run: |
          docker exec nhl-backend alembic upgrade head

      - name: Test API endpoints
        run: |
          echo "Testing /health endpoint..."
          curl -f http://localhost:8000/health | jq .

          echo "Testing /api/games/recent endpoint..."
          curl -f http://localhost:8000/api/games/recent?limit=1 | jq .

          echo "Testing API docs..."
          curl -f http://localhost:8000/docs | head -10

      - name: Check container logs
        if: always()
        run: |
          echo "=== Backend Logs ==="
          docker logs nhl-backend --tail=50
          echo "=== Frontend Logs ==="
          docker logs nhl-frontend --tail=50
          echo "=== PostgreSQL Logs ==="
          docker logs nhl-postgres --tail=20
          echo "=== Redis Logs ==="
          docker logs nhl-redis --tail=20

      - name: Shutdown Docker Compose
        if: always()
        run: |
          docker compose down -v
